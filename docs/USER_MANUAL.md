# Lステップ集計ツール - ユーザーマニュアル

## 📚 目次

1. [はじめに](#はじめに)
2. [基本的な使い方](#基本的な使い方)
3. [画面の見方](#画面の見方)
4. [機能詳細](#機能詳細)
5. [スプレッドシート出力](#スプレッドシート出力)
6. [履歴管理](#履歴管理)
7. [よくある質問（FAQ）](#よくある質問faq)
8. [トラブルシューティング](#トラブルシューティング)

---

## はじめに

### このツールでできること

Lステップ集計ツールは、Lステップから取得した予約データを自動集計し、月1回の集計作業を**60分から3分**に短縮するツールです。

**主な機能**:
- ✅ CSVファイルの自動読み込み・集計
- ✅ 初回/2回目以降の自動判定
- ✅ 実施数・キャンセル数の自動計算
- ✅ 相談員別の実績集計
- ✅ 日別・月別のグラフ表示
- ✅ 要確認リストの自動検出（3パターン）
- ✅ スプレッドシート出力（AB~AM列への自動転記）
- ✅ 過去の集計履歴の保存・管理

### 動作環境

- **推奨ブラウザ**: Chrome、Firefox、Safari、Edge（最新版）
- **インターネット接続**: 不要（オフラインで動作可能）
- **データ保存**: ブラウザ内（IndexedDB）に保存されます

---

## 基本的な使い方

### ステップ1: CSVファイルの準備

1. **Lステップにログイン**
2. **予約管理画面を開く**
3. **CSVエクスポート機能を使用**
4. **必要な期間のデータをエクスポート**

**必須カラム**（以下の7つが含まれている必要があります）:
- `予約ID`
- `友だちID`
- `予約日`
- `ステータス`
- `来店/来場`
- `名前`
- `申込日時`

### ステップ2: CSVファイルのアップロード

#### 方法1: ドラッグ&ドロップ

1. ブラウザでツールを開く
2. CSVファイルを画面中央の「ここにCSVファイルをドロップ」エリアにドラッグ
3. ファイルをドロップして放す

#### 方法2: クリックして選択

1. 画面中央の「ここにCSVファイルをドロップ」エリアをクリック
2. ファイル選択ダイアログでCSVファイルを選択
3. 「開く」ボタンをクリック

### ステップ3: 集計結果の確認

ファイルをアップロードすると、自動的に以下の情報が表示されます:

- **集計サマリー**: 申込数、実施数、キャンセル数、実施率
- **初回/2回目以降の区分**: それぞれの申込数、実施数、実施率
- **相談員別実績**: 担当者ごとの詳細実績
- **日別推移グラフ**: 申込・実施・キャンセルの日別推移
- **月別実績グラフ**: 月ごとの実績と構成比
- **要確認リスト**: 手動確認が必要なレコード（3パターン）
- **キャンセル一覧**: すべてのキャンセルレコード

### ステップ4: スプレッドシート出力

1. 集計結果を確認
2. 画面上部の「スプレッドシート出力」ボタンをクリック
3. Excelファイル（.xlsx）が自動的にダウンロードされます

**ファイル名形式**: `Lステップ集計_YYYY年MM月_YYYYMMDD.xlsx`

---

## 画面の見方

### 1. CSVアップロードエリア

画面上部にあるファイルアップロードエリアです。

- **青い枠のエリア**: CSVファイルをドロップまたはクリックしてファイルを選択
- **アップロード後**: ファイル名が表示され、集計が自動実行されます
- **エラー表示**: ファイルに問題がある場合、赤色でエラーメッセージが表示されます

### 2. 集計サマリーカード

全体の集計結果を一目で確認できるカードです。

#### 初回の集計
- **申込数**: 初回予約の総数
- **実施数**: 初回で実際に来店/来場した数
- **キャンセル数**: 初回でキャンセルした数
- **実施率**: (実施数 ÷ 申込数) × 100

#### 2回目以降の集計
- **申込数**: 2回目以降の予約総数
- **実施数**: 2回目以降で実際に来店/来場した数
- **キャンセル数**: 2回目以降でキャンセルした数
- **実施率**: (実施数 ÷ 申込数) × 100

### 3. 相談員別実績テーブル

担当者ごとの詳細な実績を確認できます。

**表示項目**:
- **担当者名**: 相談員の名前（「未設定」は担当者が記録されていないレコード）
- **申込数**: 担当者が受けた予約総数
- **実施数**: 実際に実施された予約数
- **キャンセル数**: キャンセルされた予約数
- **実施率**: (実施数 ÷ 申込数) × 100

**機能**:
- **ソート機能**: 各列のヘッダーをクリックすると、昇順/降順で並び替え可能
- **ページング**: データが多い場合、ページ切り替えで表示

### 4. グラフ

#### 日別推移グラフ（折れ線グラフ）
- **青線**: 申込数の推移
- **緑線**: 実施数の推移
- **赤線**: キャンセル数の推移
- **横軸**: 日付
- **縦軸**: 件数

#### 月別実績グラフ

**棒グラフ**:
- **青色**: 申込数
- **緑色**: 実施数
- **赤色**: キャンセル数

**円グラフ**:
- 実施とキャンセルの構成比を表示
- 緑色: 実施
- 赤色: キャンセル

### 5. 要確認リスト（3パターン）

手動で確認が必要なレコードを自動検出します。

#### パターン1: データ不整合
- **条件**: ステータスが「キャンセル済み」なのに「来店/来場」が「済み」
- **原因**: データ入力ミスの可能性
- **対応**: Lステップ側のデータを確認・修正

#### パターン2: 未来店
- **条件**: ステータスが「予約済み」なのに「来店/来場」が「なし」
- **原因**: 来店/来場の記録漏れ、または予約日未到来
- **対応**:
  - 予約日が過去の場合: 来店/来場の記録を確認
  - 予約日が未来の場合: 問題なし（そのまま）

#### パターン3: 通常キャンセル
- **条件**: ステータスが「キャンセル済み」で「来店/来場」が「なし」
- **原因**: 正常なキャンセル（確認不要な場合が多い）
- **対応**: 念のため確認（必要に応じて理由を記録）

**表示項目**:
- **予約ID**: 予約の識別番号
- **友だちID**: LINEの友だち識別子
- **予約日**: 予約された日付
- **ステータス**: 現在の予約ステータス
- **来店/来場**: 来店/来場の記録
- **名前**: 予約者の名前
- **申込日時**: 申込が行われた日時

### 6. キャンセル一覧

すべてのキャンセルレコードを一覧表示します。

**表示項目**:
- 予約ID、友だちID、予約日、名前、申込日時
- **訪問タイプ**: 初回/2回目/3回目以降

**用途**:
- キャンセル理由の分析
- 初回キャンセルと2回目以降のキャンセル比較
- リマインド施策の検討

### 7. 集計履歴

過去に実行した集計結果を確認できます。

**表示項目**:
- **集計月**: 集計された月（YYYY年MM月）
- **集計日時**: 集計を実行した日時
- **申込数、実施数、実施率**: サマリー情報
- **初回/2回目以降**: それぞれの実施率

**機能**:
- **削除**: 不要な履歴を削除できます（確認ダイアログ表示）
- **リフレッシュ**: 最新の履歴を再読み込みします

---

## 機能詳細

### 実施判定のルール

レコードが「実施」と判定される条件:

```
ステータス === '予約済み' AND 来店/来場 === '済み'
```

**補足**:
- ステータスが「キャンセル済み」の場合、来店/来場が「済み」でも実施とはカウントされません
- 来店/来場が「なし」の場合、ステータスに関わらず実施とはカウントされません

### 初回/2回目以降の判定ルール

**履歴マスタ**を使用して、過去の実施回数をカウントします。

| 過去の実施回数 | 判定結果 |
|---------------|---------|
| 0回 | 初回 |
| 1回 | 2回目 |
| 2回以上 | 3回目以降 |

**履歴マスタの更新タイミング**:
- CSVファイルをアップロードしたとき
- 「実施」と判定されたレコードのみがカウントされます
- ブラウザのIndexedDBに永続保存されます

### 実施率の計算方法

```
実施率 = (実施数 ÷ 申込数) × 100
```

- 小数点第1位まで表示（例: 85.7%）
- 申込数が0の場合、実施率は「-」または「0.0%」と表示

---

## スプレッドシート出力

### 出力内容

Excel形式（.xlsx）で以下のデータが出力されます。

#### AB~AM列への8項目出力

| 列 | 項目名 | 説明 |
|----|-------|------|
| AB | 初回予約合計 | 初回の申込数 |
| AC | 初回予約率(%) | 初回の申込数 ÷ 全体の申込数 × 100 |
| AD | 初回実施合計 | 初回の実施数 |
| AE | 初回実施率(%) | 初回の実施数 ÷ 初回の申込数 × 100 |
| AJ | 2回目以降予約合計 | 2回目以降の申込数 |
| AK | 2回目以降予約率(%) | 2回目以降の申込数 ÷ 全体の申込数 × 100 |
| AL | 2回目以降実施合計 | 2回目以降の実施数 |
| AM | 2回目以降実施率(%) | 2回目以降の実施数 ÷ 2回目以降の申込数 × 100 |

#### TTL行（合計行）

最終行に「TTL」という合計行が自動追加されます。

### ファイル名

自動生成されるファイル名:

```
Lステップ集計_YYYY年MM月_YYYYMMDD.xlsx
```

**例**: `Lステップ集計_2025年12月_20251201.xlsx`

### ダウンロード方法

1. 集計結果を確認
2. 画面上部の「スプレッドシート出力」ボタンをクリック
3. ブラウザのダウンロードフォルダにファイルが保存されます

### Excelでの編集

ダウンロードしたファイルは、Microsoft ExcelやGoogle スプレッドシートで開いて編集できます。

---

## 履歴管理

### 自動保存機能

CSVファイルをアップロードして集計を実行すると、以下の情報が**自動的に保存**されます:

- 集計月（YYYY-MM形式）
- 集計サマリー（申込数、実施数、キャンセル数、実施率）
- 相談員別実績
- 日別集計
- 月別集計
- スプレッドシート出力データ
- 集計実行日時

### 履歴の確認方法

1. 画面下部の「集計履歴」セクションまでスクロール
2. 過去の集計結果が新しい順に表示されます
3. 各履歴カードには以下の情報が表示されます:
   - 集計月（例: 2025年12月）
   - 集計日時（例: 2025/12/01 14:30:45）
   - サマリー情報（申込数、実施数、実施率）
   - 初回/2回目以降の実施率

### 履歴の削除方法

1. 削除したい履歴カードの「削除」ボタンをクリック
2. 確認ダイアログが表示されます
3. 「OK」をクリックすると、履歴が完全に削除されます

**注意**: 削除した履歴は復元できません。

### データの保存場所

- すべてのデータは**ブラウザ内（IndexedDB）**に保存されます
- 外部サーバーには送信されません
- ブラウザのキャッシュをクリアすると、履歴も削除されます

---

## よくある質問（FAQ）

### Q1: CSVファイルがアップロードできません

**考えられる原因**:

1. **ファイル形式が正しくない**
   - 解決策: ファイルの拡張子が `.csv` であることを確認してください

2. **ファイルサイズが大きすぎる（10MB以上）**
   - 解決策: 期間を分割して複数回に分けて集計してください

3. **必須カラムが不足している**
   - 解決策: Lステップからエクスポートする際、以下の7つのカラムが含まれるようにしてください:
     - 予約ID、友だちID、予約日、ステータス、来店/来場、名前、申込日時

4. **ファイルが空**
   - 解決策: CSVファイルにデータが含まれていることを確認してください

### Q2: 実施率が合いません

**確認事項**:

1. **実施判定のルールを確認**
   - ステータスが「予約済み」かつ「来店/来場」が「済み」のレコードのみが実施としてカウントされます

2. **CSVデータの整合性を確認**
   - 「要確認リスト」のパターン1（データ不整合）を確認してください

3. **計算式を確認**
   - 実施率 = (実施数 ÷ 申込数) × 100

### Q3: 初回と2回目以降の判定が正しくありません

**考えられる原因**:

1. **履歴マスタが更新されていない**
   - 解決策: 過去のデータを先にアップロードして、履歴マスタを構築してください

2. **友だちIDが正しく記録されていない**
   - 解決策: Lステップ側で友だちIDが正しく記録されているか確認してください

3. **ブラウザのキャッシュがクリアされた**
   - 解決策: 過去のデータを再度アップロードして履歴マスタを再構築してください

### Q4: スプレッドシート出力ボタンが押せません

**考えられる原因**:

1. **CSVファイルがアップロードされていない**
   - 解決策: まずCSVファイルをアップロードしてください

2. **集計が完了していない**
   - 解決策: 集計結果が画面に表示されるまで待ってください

### Q5: 過去の履歴が表示されません

**考えられる原因**:

1. **ブラウザのキャッシュ・Cookieがクリアされた**
   - 解決策: IndexedDBに保存されたデータも削除されている可能性があります。過去のCSVファイルを再度アップロードしてください

2. **別のブラウザを使用している**
   - 解決策: データはブラウザごとに保存されます。以前使用していたブラウザで開いてください

3. **プライベートモード/シークレットモードを使用している**
   - 解決策: 通常モードのブラウザで開いてください

### Q6: オフラインで使えますか？

**回答**: はい、使えます。

- 一度ブラウザでツールを開けば、その後はオフラインでも動作します
- すべてのデータ処理はブラウザ内で完結します
- インターネット接続は不要です

### Q7: データは安全ですか？

**回答**: はい、安全です。

- すべてのデータは**ブラウザ内（IndexedDB）**に保存されます
- 外部サーバーへの送信は一切ありません
- データは同一オリジン（同じドメイン）からのみアクセス可能です
- 完全にプライベートな環境で動作します

### Q8: 複数の月をまとめて集計できますか？

**回答**: いいえ、できません。

- このツールは月ごとの集計を前提としています
- 複数月のデータを含むCSVファイルをアップロードすると、すべてまとめて集計されます
- 月別に分けて集計したい場合は、月ごとにCSVファイルを分割してアップロードしてください

### Q9: スマートフォンで使えますか？

**回答**: はい、使えます。

- レスポンシブデザインに対応しています
- スマートフォンやタブレットでも操作可能です
- ただし、大きな画面（PC）での操作を推奨します

---

## トラブルシューティング

### エラーメッセージ一覧

#### 「CSVファイルを選択してください（拡張子: .csv）」

- **原因**: アップロードしたファイルがCSV形式ではありません
- **解決策**: ファイルの拡張子を確認し、`.csv` ファイルをアップロードしてください

#### 「ファイルサイズが大きすぎます（最大: 10MB）」

- **原因**: ファイルサイズが10MBを超えています
- **解決策**:
  1. 期間を分割してエクスポート
  2. 複数回に分けて集計

#### 「ファイルが空です」

- **原因**: CSVファイルにデータが含まれていません
- **解決策**: Lステップから正しくデータをエクスポートしてください

#### 「必須カラムが不足しています」

- **原因**: 以下の7つのカラムのいずれかが不足しています
  - 予約ID、友だちID、予約日、ステータス、来店/来場、名前、申込日時
- **解決策**: Lステップのエクスポート設定を確認し、すべてのカラムを含めてください

#### 「CSVファイルの解析中にエラーが発生しました」

- **原因**: CSVファイルの形式が正しくありません
- **解決策**:
  1. ファイルをテキストエディタで開いて確認
  2. 文字コードがUTF-8であることを確認
  3. 改行コードが正しいことを確認

#### 「スプレッドシートの生成に失敗しました」

- **原因**: ブラウザの制限やメモリ不足の可能性があります
- **解決策**:
  1. ブラウザを再起動
  2. 他のタブを閉じてメモリを確保
  3. データ量を減らして再試行

### パフォーマンスの問題

#### 集計に時間がかかる

- **原因**: データ量が多い、またはブラウザのリソース不足
- **解決策**:
  1. 他のタブやアプリを閉じる
  2. データを月別に分割して集計
  3. より高性能なPCを使用

#### ブラウザが固まる・応答しない

- **原因**: データ量が非常に多い、またはメモリ不足
- **解決策**:
  1. ブラウザを再起動
  2. データを小分けにして集計
  3. メモリを増設したPCを使用

### ブラウザ固有の問題

#### Safari で履歴が保存されない

- **原因**: Safari のプライベートモードまたは設定の問題
- **解決策**:
  1. プライベートモードを無効化
  2. Safari の「クロスサイトトラッキングを防ぐ」設定を確認

#### Firefox でファイルダウンロードができない

- **原因**: Firefox の設定またはポップアップブロッカー
- **解決策**:
  1. ポップアップブロッカーを無効化
  2. ダウンロード設定を確認

### データの問題

#### 要確認リストのパターン1が多数表示される

- **原因**: Lステップ側のデータ入力ミス
- **対応**:
  1. Lステップ側でデータを確認
  2. ステータスと来店/来場の整合性を確保
  3. 必要に応じてデータを修正

#### 実施率が100%を超える

- **原因**: データの異常（通常は発生しません）
- **対応**:
  1. CSVファイルを確認
  2. 重複レコードがないか確認
  3. サポートに問い合わせ

---

## サポート・お問い合わせ

### 問題が解決しない場合

1. **ブラウザのコンソールを確認**（開発者ツール）
   - Chrome: F12キー → Consoleタブ
   - Firefox: F12キー → コンソールタブ
   - Safari: Cmd+Option+C

2. **エラーメッセージをコピー**

3. **問題の詳細を記録**
   - 何をしようとしていたか
   - どのようなエラーが発生したか
   - 使用しているブラウザとバージョン
   - CSVファイルのサイズ・レコード数

4. **GitHubでIssueを作成**
   - リポジトリのIssuesページに問題を報告してください

---

**最終更新日**: 2025-12-02
**バージョン**: 2.1
**ドキュメントバージョン**: 1.0
