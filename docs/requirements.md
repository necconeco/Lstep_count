# Lステップ集計ツール - 要件定義書 v2.1

**最終更新**: 2025-12-01
**バージョン**: 2.1（実CSV構造対応版）

---

## 要件定義の作成原則

- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標

Lステップのカレンダー予約CSVをアップロードするだけで、
**マスターデータ（履歴テーブル）**を参照しながら、
初回/2回目以降の判定を**精度100%**で行い、
**Googleスプレッドシートの指定列（AB～AM列）**に日別・月次集計結果を自動出力するツールを構築する。

**業務時間削減（60分→5分）・データ品質向上・要確認レコードの可視化**を実現することが目的。

---

### 1.2 成功指標

#### 定量的指標

- 月次集計作業時間が**手作業の1/10以下**（60分→5分以内）
- 要確認レコードの検出精度**100%**（データ不整合を全件抽出）
- 初回/2回目判定の精度**100%**（マスターデータ前提）
- 転換率計算の精度**100%**（実施数÷申込数）

#### 定性的指標

- CSVアップロードだけで全集計が完了する
- 手作業での転記ミス・計算ミスがゼロになる
- 要確認レコードを見逃さず、データ品質が向上する
- 過去との比較が簡単にできる

---

## 2. システム全体像

### 2.1 主要機能一覧

#### 必須機能

- **CSV処理機能**: LステップCSVのアップロード、パース、バリデーション
- **マスターデータ管理**: 友だちIDベースの履歴テーブル（IndexedDB）
- **自動集計機能**: 申込数、実施数、初回/2回目以降、転換率
- **要確認リスト**: データ不整合・未来店などを自動検出（3パターン）
- **キャンセル一覧**: キャンセル済みレコードの一覧出力
- **スプレッドシート出力**: 既存Googleスプレッドシートの**AB～AM列**に日別データを出力
- **月次サマリー**: TTL行（合計行）の自動生成

#### オプション機能（できれば）

- **相談員別集計**: 担当者別の実施件数（表記ゆれにより精度100%でなくてもOK）

---

### 2.2 ユーザーロールと権限（MVPルート：認証なし）

- **ゲストユーザー**: すべての機能にアクセス可能（個人利用のため認証不要）

---

### 2.3 認証・認可要件

- 認証方式: **なし**（個人利用のため）
- セキュリティレベル: **データはブラウザ内で処理**、外部送信なし
- 管理機能: 不要

---

## 3. CSV構造の詳細仕様

### 3.1 実際のCSV列構成

Lステップからダウンロードされるキャリア相談予約CSVには、以下のカラムが含まれます：

| 列名 | 説明 | 必須 | 備考 |
|------|------|------|------|
| 予約ID | 各予約の一意のID | ✅ | - |
| 友だちID | LINEユーザーを識別するID | ✅ | マスターデータの主キー |
| メッセージID | 予約発生元のメッセージID | - | - |
| 予約日 | 相談予約日 | ✅ | 日別集計のキー |
| コース | 「キャリア相談＜初回＞」「キャリア相談＜2回目以降＞」など | - | 補助的に使用 |
| 予約枠（担当者名） | 実施担当者（例：押谷ゆきな、河野孝匡など） | - | 相談員別集計に使用 |
| ステータス | 「予約済み」「キャンセル済み」 | ✅ | **2種類のみ** |
| 予約メモ | 相談員が追加したメモ | - | 補助情報 |
| 名前 | 申込者名 | ✅ | 表示用 |
| メールアドレス | 申込者のメールアドレス | - | - |
| 申込日時 | 予約フォーム送信日時 | ✅ | - |
| 相談回数 | 「初めて」「2回目以上」など | - | **毎回入っているとは限らない** |
| **来店/来場** | **「済み」「なし」など** | ✅ | **実施判定の最重要列** |

---

### 3.2 CSV仕様による制約（できないこと）

CSVの仕様上、次の情報は自動判定ができない:

1. **キャンセル日時**: 何日の何時にキャンセルしたか
2. **キャンセル理由**: なぜキャンセルしたか
3. **前日/当日キャンセルの区別**: キャンセル日時が存在しないため判定不可
4. **実施完了の専用ステータス**: ステータスは「予約済み」「キャンセル済み」のみ
5. **実施日時**: 完了報告のタイムスタンプ
6. **ユーザーの累計相談回数**: CSV単体では不完全（マスターデータで管理）

---

### 3.3 バリデーションルール

```yaml
友だちID:
  - ルール: 必須、空文字不可
  - 理由: ユーザーの一意識別と履歴判定のため

予約日:
  - ルール: 必須、有効な日付形式
  - 理由: 日別集計のため

ステータス:
  - ルール: 必須、「予約済み」または「キャンセル済み」のみ
  - 理由: 実施/未実施判定の正確性確保のため

来店/来場:
  - ルール: 必須、「済み」「なし」などの値
  - 理由: 実施判定の最重要項目

名前:
  - ルール: 必須
  - 理由: 要確認リスト等での表示用

申込日時:
  - ルール: 必須、有効な日時形式
  - 理由: 集計処理のため

CSVファイルサイズ:
  - ルール: 10MB以下
  - 理由: ブラウザメモリ制限とパフォーマンス確保のため
```

---

## 4. 実施判定ロジック

### 4.1 実施済みの定義

**実施済み**:
```
ステータス = 「予約済み」
かつ
来店/来場 = 「済み」
```

→ この条件を満たすレコードのみを「実施数」として集計

---

### 4.2 要確認リストの定義

以下の**3パターン**のレコードを「要確認リスト」として自動検出し、一覧表示する:

#### パターン1: データ不整合の可能性
```
ステータス = 「キャンセル済み」
かつ
来店/来場 = 「済み」
```

**意味**: キャンセルしたはずなのに来店済みになっている → データ入力ミスの可能性

---

#### パターン2: 未来店または入力漏れ
```
ステータス = 「予約済み」
かつ
来店/来場 = 「なし」
```

**意味**: 予約したが来店していない、または来店情報が未入力 → 確認が必要

---

#### パターン3: 正常なキャンセル（念のため確認）
```
ステータス = 「キャンセル済み」
かつ
来店/来場 = 「なし」
```

**意味**: キャンセルして来店していない → 正常だが、念のため確認したい

---

### 4.3 キャンセル一覧の定義

```
ステータス = 「キャンセル済み」
```

**すべてのキャンセル済みレコード**を一覧表示する（パターン1とパターン3を含む）

**理由**: 現状、キャンセルは一件ずつ目視で確認しているため、一覧で出力できる機能が必須

**注意**: CSV上では前日/当日の区別が取得できないため、まとめて「キャンセル一覧」として出力

---

## 5. マスターデータ（履歴テーブル）設計

### 5.1 目的

- **初回/2回目/3回目以降を正確に判定するため**
- CSV単体では過去の実施履歴が完全には含まれないため、マスターデータでの履歴管理が必須

---

### 5.2 マスター構造

```yaml
UserHistoryMaster:
  friendId: string             # 友だちID（主キー、必須）
  implementationCount: number  # 過去実施回数（実施済みの件数）
  lastImplementationDate: Date | null  # 最終実施日
  createdAt: Date              # マスター作成日時
  updatedAt: Date              # マスター更新日時
```

**補足**:
- 実施回数のカウント対象: **ステータスが「予約済み」かつ「来店/来場」が「済み」のレコード**
- キャンセル済み、未来店は実施回数にカウントしない

---

### 5.3 運用フロー

#### 初回セットアップ

1. **過去CSVのアップロード**（初回のみ）
   - 過去の全CSVファイルを読み込む
   - 友だちIDごとに実施回数をカウント
   - マスターデータを生成
   - IndexedDBに保存

2. **マスターデータの確認**
   - 生成されたマスターデータを画面に表示
   - 件数、最終更新日などを確認

#### 通常運用（2回目以降）

1. **新しいCSVの読み込み**
   - CSVをアップロード
   - マスターデータを参照

2. **初回/2回目以降の判定**
   - 各レコードについて、その時点でのマスターデータを参照
   - 過去実施回数が0件 → **初回**
   - 過去実施回数が1件以上 → **2回目以降**

3. **マスターデータの更新**
   - 実施済み（ステータス「予約済み」かつ「来店/来場」が「済み」）のレコードがあれば:
     - マスターデータの実施回数を+1
     - 最終実施日を更新
   - IndexedDBに保存

---

### 5.4 必須理由

- CSV単体では「初回/2回目」の判定ができないため
- 正確な転換率・移行率を算出できるようにするため
- 過去データとの整合性を保つため

---

## 6. ページ詳細仕様

### 6.1 P-001: Lステップ集計ダッシュボード

#### 目的

CSVアップロードから集計・分析・スプレッドシート出力まで1ページで完結し、月1回の集計作業を60分→3分に短縮する

---

#### 主要機能

##### 1. マスターデータ管理セクション

**初回セットアップ（初回のみ表示）**:
- 過去CSVのアップロード（複数ファイル対応）
- マスターデータの自動生成
- 生成結果の確認表示（友だちID数、実施回数分布など）

**通常運用時（マスター存在時）**:
- マスターデータの概要表示（総件数、最終更新日）
- マスターデータのリセット機能
- マスターデータのエクスポート機能（バックアップ用）

---

##### 2. CSVアップロードセクション

- ドラッグ&ドロップでのCSVファイルアップロード
- ファイル選択ボタン（従来方式）
- アップロード前のファイル情報表示（ファイル名、サイズ、行数）
- CSVバリデーション（必須カラムの存在確認）

---

##### 3. 集計結果表示セクション

**3-1. サマリーカード（上部）**

内部計算のみ、画面表示用:
- 申込数（CSVデータ行数、ヘッダー除く）
- 実施数（ステータス「予約済み」かつ「来店/来場」が「済み」の件数）
- 転換率（実施数÷申込数×100%）
- 初回数/2回目以降数

**3-2. 初回/2回目以降集計**

- **初回予約合計**: 友だちID単位で、過去に実施履歴がない状態での予約件数
- **初回予約率**: 初回予約合計 ÷ 全予約数 × 100%
- **初回実施合計**: 初回予約のうち、実施済み（ステータス「予約済み」かつ「来店/来場」が「済み」）になった件数
- **初回実施率**: 初回実施合計 ÷ 初回予約合計 × 100%
- **2回目以降予約合計**: 過去に1回以上実施履歴があるユーザーの予約件数
- **2回目以降予約率**: 2回目以降予約合計 ÷ 全予約数 × 100%
- **2回目以降実施合計**: 2回目以降予約のうち、実施済みになった件数
- **2回目以降実施率**: 2回目以降実施合計 ÷ 2回目以降予約合計 × 100%

---

##### 4. 要確認リストセクション（新規・重要）

**目的**: データ不整合・未来店などを可視化し、手動確認を促す

**表示方法**: タブまたはセクションで3パターンを分けて表示

**パターン1: データ不整合の可能性**
- 条件: ステータス = 「キャンセル済み」 ＆ 来店/来場 = 「済み」
- 表示項目: 友だちID、名前、予約日、担当者、ステータス、来店/来場、予約メモ
- 件数の警告表示（例：⚠️ 3件のデータ不整合を検出）

**パターン2: 未来店または入力漏れ**
- 条件: ステータス = 「予約済み」 ＆ 来店/来場 = 「なし」
- 表示項目: 友だちID、名前、予約日、担当者、ステータス、来店/来場、予約メモ
- 件数の警告表示（例：⚠️ 5件の未来店/入力漏れを検出）

**パターン3: 正常なキャンセル（念のため確認）**
- 条件: ステータス = 「キャンセル済み」 ＆ 来店/来場 = 「なし」
- 表示項目: 友だちID、名前、予約日、担当者、ステータス、来店/来場、予約メモ
- 件数の表示（例：ℹ️ 8件の正常なキャンセル）

**出力機能**:
- CSV形式でダウンロード（パターンごとに別ファイル）
- Excel形式でダウンロード（1ファイル、シートを分ける）

---

##### 5. キャンセル一覧セクション（新規・必須）

**目的**: すべてのキャンセル済みレコードを一覧で確認

**条件**: ステータス = 「キャンセル済み」

**表示項目**: 友だちID、名前、予約日、担当者、来店/来場、予約メモ、申込日時

**注意**: 前日/当日の区別はCSV上では取得できないため、まとめて表示

**出力機能**:
- CSV形式でダウンロード
- Excel形式でダウンロード

---

##### 6. スプレッドシート出力セクション（最重要機能）

**目的**: 既存のGoogleスプレッドシート『千葉県学びの総合窓口数値管理表』の**AB～AM列**への出力用データを生成

**6-1. 出力列の仕様**

**出力対象列**（AB～AM列のみ）:
```
AB列: 初回予約合計
AC列: 初回予約率（%）
AD列: 初回実施合計
AE列: 初回実施率（%）
（AF～AI列: 未使用または別用途）
AJ列: 2回目以降予約合計
AK列: 2回目以降予約率（%）
AL列: 2回目以降実施合計
AM列: 2回目以降実施率（%）
```

**データ形式**:
- 1日 = 1行
- CSVアップロード期間の全日付分を出力
- 予約がない日は0件として表示
- TTL行（月次合計）も自動生成

**重要な仕様**:
- **申込数・実施数・キャンセル数は内部計算のみ**
- **スプレッドシートにはAB～AM列のみを出力**
- 既存のF～AA列には新しいデータを追加しない

**6-2. 出力ボタン**

- **[コピペ用テーブルを表示]**: 画面上にテーブル形式で表示、ユーザーが選択してコピー可能
- **[CSV形式でダウンロード]**: `日別データ_YYYY年MM月_YYYYMMDD.csv` 形式でダウンロード
- **[Excel形式でダウンロード]**: `日別データ_YYYY年MM月_YYYYMMDD.xlsx` 形式でダウンロード

**6-3. 使用イメージ**

```
1. CSVをアップロード
2. 集計結果を確認
3. 要確認リストを確認し、必要に応じて手動調整
4. 「コピペ用テーブルを表示」をクリック
5. AB～AM列のデータをコピー（Ctrl+A → Ctrl+C）
6. 既存スプシのAB列から貼り付け（値のみ貼り付け）
7. 必要に応じてスプシ側の値を手動で調整
```

---

##### 7. 過去データ比較セクション（オプション）

- 過去の集計結果一覧（月別、ブラウザIndexedDBに保存）
- 月次比較グラフ（転換率の推移）
- 過去レポートの再ダウンロード
- データの削除機能

---

##### 8. 相談員別集計セクション（オプション）

**優先度**: できれば実装

**注意**: 表記ゆれにより精度100%でなくてもOK

- 担当者名の一覧表示・編集
- 担当者別の実施件数
- 担当者別の転換率

---

#### 必要な操作

| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | CSVファイルの読み込み | CSVファイル | パース済みデータ |
| 作成 | マスターデータの生成 | 過去CSV（複数） | 履歴テーブル |
| 取得 | マスターデータの参照 | 友だちID | 過去実施回数 |
| 更新 | マスターデータの更新 | 新規実施レコード | 更新済みマスター |
| 作成 | 集計結果の生成 | パース済みデータ + マスター | 集計レポート |
| 作成 | 要確認リストの生成 | パース済みデータ | 3パターンの要確認レコード |
| 作成 | キャンセル一覧の生成 | パース済みデータ | キャンセル済みレコード一覧 |
| 作成 | スプシ出力データの生成 | 集計レポート | AB～AM列のデータ |
| 作成 | コピペ用テーブルの表示 | AB～AM列データ | HTML形式のテーブル |
| 作成 | CSV形式でダウンロード | AB～AM列データ | ダウンロード可能なCSVファイル |
| 作成 | Excel形式でダウンロード | AB～AM列データ | ダウンロード可能なExcelファイル |
| 保存 | 集計結果の保存 | 集計レポート | IndexedDBへの保存完了 |
| 取得 | 過去の集計結果の取得 | なし | 保存済み集計結果一覧 |
| 削除 | 過去の集計結果の削除 | 集計結果ID | 削除完了 |

---

#### 処理フロー

**初回セットアップ時**:

1. **過去CSVのアップロード**
   - ユーザーが過去の全CSVファイルをアップロード（複数ファイル対応）
   - PapaParseでCSVをパース
   - 必須カラムの存在確認（友だちID、予約日、ステータス、来店/来場、名前、申込日時）

2. **マスターデータの生成**
   - 全CSVを統合
   - 友だちIDと予約日でソート（時系列順）
   - 友だちIDごとにグルーピング
   - 実施済み（ステータス「予約済み」かつ「来店/来場」が「済み」）のレコードをカウント
   - マスターデータを生成
   - IndexedDBに保存

3. **マスターデータの確認**
   - 生成されたマスターデータの概要を表示
   - 友だちID数、実施回数分布などを確認

---

**通常運用時（2回目以降）**:

1. **CSVアップロード**
   - ユーザーが新しいCSVファイルをアップロード
   - PapaParseでCSVをパース
   - 必須カラムの存在確認

2. **データ前処理**
   - 予約日のパース（文字列→Date型）
   - ステータスの正規化（全角/半角、大文字/小文字の統一）
   - 「来店/来場」の正規化
   - 予約枠から担当者名を抽出（オプション）
   - 友だちIDと予約日でソート（時系列順）

3. **マスターデータの参照と初回/2回目判定**
   - IndexedDBからマスターデータを取得
   - 各レコードについて、友だちIDでマスターを検索
   - 過去実施回数が0件 → **初回**
   - 過去実施回数が1件以上 → **2回目以降**
   - 判定結果をレコードに付与

4. **集計処理**
   - **申込数**: データ行数をカウント
   - **実施数**: ステータスが「予約済み」かつ「来店/来場」が「済み」の件数
   - **転換率**: 実施数÷申込数×100%
   - **初回予約合計**: 初回フラグが立っているレコードの件数
   - **初回実施合計**: 初回フラグ + 実施済みのレコードの件数
   - **初回予約率**: 初回予約合計 ÷ 申込数 × 100%
   - **初回実施率**: 初回実施合計 ÷ 初回予約合計 × 100%
   - **2回目以降予約合計**: 2回目以降フラグが立っているレコードの件数
   - **2回目以降実施合計**: 2回目以降フラグ + 実施済みのレコードの件数
   - **2回目以降予約率**: 2回目以降予約合計 ÷ 申込数 × 100%
   - **2回目以降実施率**: 2回目以降実施合計 ÷ 2回目以降予約合計 × 100%
   - **日別集計**: 予約日でグルーピングして集計
   - **相談員別集計**（オプション）: 担当者名でグルーピングして集計

5. **要確認リストの生成**
   - **パターン1**: ステータス = 「キャンセル済み」 ＆ 来店/来場 = 「済み」のレコードを抽出
   - **パターン2**: ステータス = 「予約済み」 ＆ 来店/来場 = 「なし」のレコードを抽出
   - **パターン3**: ステータス = 「キャンセル済み」 ＆ 来店/来場 = 「なし」のレコードを抽出
   - 各パターンの検出件数と詳細リストを表示

6. **キャンセル一覧の生成**
   - ステータス = 「キャンセル済み」のレコードを抽出
   - 一覧表示（友だちID、名前、予約日、担当者、来店/来場、予約メモ、申込日時）

7. **マスターデータの更新**
   - 実施済み（ステータス「予約済み」かつ「来店/来場」が「済み」）のレコードについて:
     - マスターデータの実施回数を+1
     - 最終実施日を更新
   - IndexedDBに保存

8. **結果表示**
   - 集計結果を各セクションに表示
   - グラフを描画（Recharts使用、オプション）
   - 要確認リストがあれば警告表示
   - キャンセル一覧を表示

9. **データ保存**
   - 集計結果をIndexedDBに保存（月別）
   - 保存完了メッセージを表示

10. **スプレッドシート出力データの生成**
   - 予約日ごとにデータをグルーピング
   - 各日について以下を算出：
     - AB列: 初回予約合計
     - AC列: 初回予約率（%）
     - AD列: 初回実施合計
     - AE列: 初回実施率（%）
     - AJ列: 2回目以降予約合計
     - AK列: 2回目以降予約率（%）
     - AL列: 2回目以降実施合計
     - AM列: 2回目以降実施率（%）
   - TTL行（月次合計）を生成
   - コピペ用テーブルまたはCSV/Excel形式で出力

---

#### データ構造（概念）

```yaml
CSVレコード:
  識別子: 友だちID（一意のユーザー識別子）
  基本情報:
    - 予約ID（任意）
    - 名前（必須）
    - メールアドレス（任意）
  予約情報:
    - 予約日（必須）
    - コース（任意）
    - 予約枠（担当者名）（任意）
    - 申込日時（必須）
  ステータス情報:
    - ステータス（必須：「予約済み」「キャンセル済み」のみ）
    - 来店/来場（必須：「済み」「なし」など）
    - 予約メモ（任意）
  補助情報:
    - メッセージID（任意）
    - 相談回数（任意）
  算出項目:
    - 初回フラグ（算出：マスターの過去実施回数が0件→true）
    - 実施フラグ（算出：ステータス「予約済み」かつ「来店/来場」が「済み」→true）

マスターデータ（UserHistoryMaster）:
  識別子: 友だちID（主キー）
  履歴情報:
    - 過去実施回数（必須）
    - 最終実施日（任意）
  メタ情報:
    - 作成日時
    - 更新日時

集計結果:
  識別子: 集計ID（日時ベース）
  基本情報:
    - 集計年月（必須）
    - 集計日時（必須）
    - 対象期間（開始日、終了日）
  サマリー:
    - 申込数（必須、内部計算のみ）
    - 実施数（必須、内部計算のみ）
    - 転換率（必須、内部計算のみ）
    - 初回予約合計、初回実施合計、初回予約率、初回実施率
    - 2回目以降予約合計、2回目以降実施合計、2回目以降予約率、2回目以降実施率
  詳細集計:
    - 日別集計（配列）
    - 要確認リスト（パターン1、2、3の配列）
    - キャンセル一覧（配列）
    - 相談員別実績（配列、オプション）
  メタ情報:
    - 作成日時
    - CSVファイル名
```

---

## 7. データ設計概要

### 7.1 主要エンティティ

```yaml
CSVレコード（入力データ）:
  概要: Lステップからダウンロードした予約データの1レコード
  主要属性:
    - 識別情報: 友だちID、名前
    - 予約情報: 予約日、コース、予約枠（担当者名）、申込日時
    - ステータス: ステータス（「予約済み」「キャンセル済み」）、来店/来場、予約メモ
  関連:
    - マスターデータ（多対1：友だちIDで紐づく）
    - 集計結果（多対1：複数レコードから1つの集計結果）

マスターデータ（UserHistoryMaster）:
  概要: 友だちIDベースの履歴テーブル
  主要属性:
    - 友だちID（主キー）
    - 過去実施回数
    - 最終実施日
    - 作成日時、更新日時
  保存先: IndexedDB
  関連:
    - CSVレコード（1対多：1人のユーザーが複数レコードを持つ）

集計結果（出力データ）:
  概要: CSV全体から算出された集計レポート
  主要属性:
    - サマリー: 申込数、実施数、転換率、初回/2回目以降の指標
    - 詳細集計: 日別、要確認リスト、キャンセル一覧
    - メタ情報: 集計年月、集計日時、CSVファイル名
  関連:
    - CSVレコード（1対多：1つの集計結果は複数レコードから生成）
    - 過去集計結果（自己参照：月次比較のため）

日別データ（スプシ出力用）:
  概要: Googleスプレッドシートの AB～AM列 への出力用データ
  主要属性:
    - 予約日（A列、既存）
    - AB列: 初回予約合計
    - AC列: 初回予約率（%）
    - AD列: 初回実施合計
    - AE列: 初回実施率（%）
    - AJ列: 2回目以降予約合計
    - AK列: 2回目以降予約率（%）
    - AL列: 2回目以降実施合計
    - AM列: 2回目以降実施率（%）
  出力形式:
    - 1日 = 1行
    - コピペ用HTMLテーブル
    - CSV形式ダウンロード
    - Excel形式ダウンロード
  関連:
    - 集計結果（1対多：1つの集計結果から複数日のデータを生成）

要確認リスト:
  概要: データ不整合・未来店などのレコード
  パターン:
    - パターン1: ステータス「キャンセル済み」＆ 来店/来場「済み」
    - パターン2: ステータス「予約済み」＆ 来店/来場「なし」
    - パターン3: ステータス「キャンセル済み」＆ 来店/来場「なし」
  出力形式:
    - タブ/セクション別表示
    - CSV/Excel形式ダウンロード

キャンセル一覧:
  概要: すべてのキャンセル済みレコード
  条件: ステータス = 「キャンセル済み」
  出力形式:
    - 一覧表示
    - CSV/Excel形式ダウンロード
```

---

### 7.2 エンティティ関係図

```
過去CSV（複数）
      ↓
   [初回セットアップ]
      ↓
マスターデータ（IndexedDB）
      ↓
      ↓
新規CSV
      ↓
   [マスター参照 + 初回/2回目判定]
      ↓
   [集計処理]
      ↓
   集計結果（1つ）
      ├─ サマリー（申込数、実施数、初回/2回目指標）
      ├─ 日別集計
      ├─ 要確認リスト（パターン1、2、3）
      └─ キャンセル一覧
      ↓
   [スプシ出力データ生成]
      ↓
AB～AM列のデータ（日別 + TTL行）
      ↓
コピペ用テーブル / CSV / Excel
```

---

## 8. 制約事項

### CSV構造の制約

- **必須カラム**: 友だちID、予約日、ステータス、来店/来場、名前、申込日時
- **カラム名の柔軟性**: カラム名は完全一致ではなく、部分一致で許容（例：「友達ID」「友だちID」「友だち ID」）
- **ファイルサイズ制限**: 10MB以下（通常の月次データは1MB未満）
- **文字コード**: UTF-8（BOM付きも対応）

---

### ブラウザ制約

- **対応ブラウザ**: Chrome、Edge、Safari、Firefox の最新版
- **IndexedDB容量**: ブラウザごとに異なるが、通常50MB以上は利用可能
- **JavaScript有効**: JavaScriptが無効な環境では動作不可

---

### データ処理制約

- **処理可能行数**: 通常100万行まで対応（ブラウザメモリ8GBの場合）
- **処理時間**: 10万行で約3秒、100万行で約10秒を想定
- **同時処理**: 1つのCSVファイルのみ処理可能（並列処理不可）

---

## 9. セキュリティ要件

### 9.1 基本方針

本プロジェクトは **CVSS 3.1（Common Vulnerability Scoring System）** に準拠したセキュリティ要件を満たすこと。

CVSS 3.1の評価観点:
- **機密性（Confidentiality）**: データはブラウザ内で処理、外部送信なし
- **完全性（Integrity）**: データ改ざん防止、入力検証
- **可用性（Availability）**: オフライン動作可能

---

### 9.2 プロジェクト固有の必須要件

**認証機能がない場合（このプロジェクト）**:
- ✅ CSVインジェクション対策（数式開始文字のエスケープ）
- ✅ ファイルサイズ制限（10MB、DoS対策）
- ✅ MIME typeバリデーション（text/csvのみ許可）
- ✅ XSS対策（ユーザー入力のサニタイゼーション）
- ✅ セキュリティヘッダー設定（本番環境）

**データプライバシー要件**:
- ✅ すべてのデータはブラウザ内で処理
- ✅ 外部サーバーへのデータ送信なし
- ✅ IndexedDBのデータは同一オリジンのみアクセス可能
- ✅ ダウンロードファイルはユーザーのローカルに保存

**その他の一般要件**:
- ✅ HTTPSの強制（本番環境）
- ✅ エラーメッセージでの情報漏洩防止
- ✅ CSP（Content Security Policy）の設定

---

## 10. 技術スタック

```yaml
フロントエンド:
  フレームワーク: React 18
  言語: TypeScript 5
  UIライブラリ: MUI v6（Material-UI）
  状態管理: Zustand
  ルーティング: なし（1ページのため）
  ビルドツール: Vite 5

CSV処理:
  パーサー: PapaParse
  データ分析: 自前実装（Danfo.jsは不使用、シンプルなロジックで実装）

データ表示:
  テーブル: TanStack Table
  グラフ: Recharts（オプション）

レポート生成:
  Excel: SheetJS (xlsx)
  CSV: 自前実装

バックエンド:
  不要: すべてフロントエンドで完結

データベース:
  ブラウザ内蔵: IndexedDB
  用途: マスターデータ、過去の集計結果

インフラ:
  ホスティング: Vercel（無料プラン）
  デプロイ: Git連携で自動デプロイ
```

---

## 11. 必要な外部サービス・アカウント

### 必須サービス

**なし**（すべてブラウザ内で完結）

### オプションサービス

| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Vercel | ホスティング | https://vercel.com | 無料プラン、GitHubアカウントで登録可能 |

---

## 12. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

---

### 拡張候補（実装はしない）

**相談員別の詳細分析**:
- 担当者別の詳細レポート
- 担当者別の転換率推移

**グラフ機能の強化**:
- インタラクティブなグラフ
- カスタマイズ可能なダッシュボード

**データ連携**:
- Googleスプレッドシートへの自動出力（Google Apps Script連携）
- Googleカレンダーとの連携

**UI/UX改善**:
- ダークモード対応
- カスタムテーマ設定

---

## 13. 拡張性の考慮事項

将来的な拡張に備えて、以下の点を設計時に考慮する：

### 13.1 ステータス判定の柔軟性

- ステータスの種類が増減しても対応できる設計
- ステータスと「実施済み」の対応関係を設定ファイル化
- 例：`config/statusMapping.ts` で管理

### 13.2 マスターデータの拡張性

- 基本構造（友だちID、実施回数、最終実施日）を維持
- 将来的に追加フィールドを追加できる設計

### 13.3 出力形式の柔軟性

- AB～AM列以外の列にも出力できるよう、設定ファイル化を検討

---

**注意**: これらの拡張性考慮は、現時点での実装には含めない。設計思想として念頭に置くのみ。実際の拡張はPhase 11で実施する。

---

## 変更履歴

- **v2.1 (2025-12-01)**: 実CSV構造対応版、要確認リスト・キャンセル一覧機能追加
- **v2.0 (2025-12-01)**: マスターデータ対応版、スプレッドシート出力仕様の明確化
- **v1.0 (2025-11-30)**: 初版作成
