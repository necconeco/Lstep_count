# バックアップ・リストア手順

## 概要

Lステップ集計ツールは、すべてのデータをブラウザのIndexedDBに保存しています。
本ドキュメントでは、データのバックアップと復元手順について説明します。

## データの保存場所

- **保存先**: ブラウザのIndexedDB（ローカルストレージ）
- **データベース名**: `lstep-aggregation-db`
- **保存されるデータ**:
  - 履歴データ（予約履歴）
  - ユーザー訪問回数
  - キャンペーン設定
  - 担当者マスタ
  - 監査ログ
  - スナップショット

## バックアップ方法

### 方法1: アプリ内エクスポート機能（推奨）

1. アプリケーションを開く
2. サイドバーの「スナップショット」をクリック
3. 「JSONエクスポート」ボタンをクリック
4. ダウンロードされたJSONファイルを安全な場所に保存

**ファイル名形式**: `lstep_backup_YYYYMMDD_HHmmss.json`

### 方法2: ブラウザ開発者ツール

1. F12キーでブラウザの開発者ツールを開く
2. 「Application」タブを選択
3. 左メニューから「IndexedDB」→「lstep-aggregation-db」を展開
4. 各ストアのデータを確認・コピー可能

## リストア（復元）方法

### 方法1: アプリ内インポート機能（推奨）

1. アプリケーションを開く
2. サイドバーの「スナップショット」をクリック
3. 「JSONインポート」ボタンをクリック
4. バックアップしたJSONファイルを選択
5. 確認ダイアログで「復元」をクリック

**注意**: インポートを行うと、現在のデータは上書きされます。

### 方法2: 新しいブラウザ/端末への移行

1. 元のブラウザでJSONエクスポートを実行
2. 新しいブラウザでアプリケーションを開く
3. JSONインポートを実行

## バックアップの推奨頻度

| 用途 | 推奨頻度 |
|------|----------|
| 日常運用 | 週1回 |
| 大量データ投入後 | 直後に1回 |
| 手動編集後 | 作業完了時に1回 |
| ブラウザ更新前 | 更新前に1回 |

## 注意事項

### IndexedDBの制限

- **容量制限**: ブラウザごとに異なるが、通常50MB〜数GB
- **プライベートブラウジング**: データが永続化されない場合あり
- **ブラウザのデータ削除**: 「閲覧履歴の削除」でIndexedDBも削除される可能性

### データ損失のリスク

以下の場合、データが失われる可能性があります：

1. ブラウザの「閲覧データを削除」を実行
2. ブラウザをアンインストール
3. OSの再インストール
4. ストレージ容量の不足
5. ブラウザのクラッシュ

**定期的なバックアップを強く推奨します。**

## トラブルシューティング

### バックアップファイルが読み込めない

1. ファイルがJSON形式であることを確認
2. ファイルが破損していないか確認
3. 別のバックアップファイルを試す

### インポート後にデータが表示されない

1. ブラウザを再読み込み（F5）
2. ブラウザのキャッシュをクリア
3. 別のブラウザで試す

### IndexedDBにアクセスできない

1. プライベートブラウジングモードでないか確認
2. ブラウザの設定でIndexedDBが有効か確認
3. ストレージ容量に空きがあるか確認

## タブ間同期

複数のタブでアプリケーションを開いている場合、BroadcastChannel APIにより
データの変更が自動的に他のタブに反映されます。

- 対応ブラウザ: Chrome、Firefox、Edge、Safari（最新版）
- 同期されるイベント:
  - CSVデータのマージ
  - データのクリア
  - 履歴の更新
  - バックアップの復元

## バックアップファイルの構造

```json
{
  "version": "1.0",
  "exportedAt": "2024-12-01T00:00:00.000Z",
  "data": {
    "histories": [...],
    "userCounts": [...],
    "campaigns": [...],
    "auditLogs": [...]
  }
}
```

## セキュリティ考慮事項

- バックアップファイルには個人情報が含まれる可能性があります
- バックアップファイルは安全な場所に保存してください
- 共有PCでの使用時は、バックアップファイルの取り扱いに注意してください
- クラウドストレージにバックアップを保存する場合は、アクセス権限を適切に設定してください

## 関連ドキュメント

- [ユーザーマニュアル](./USER_MANUAL.md)
- [開発者ガイド](./DEVELOPER_GUIDE.md)
- [デプロイメントガイド](./DEPLOYMENT.md)
